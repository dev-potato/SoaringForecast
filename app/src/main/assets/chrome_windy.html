<!DOCTYPE html>
<meta charset="UTF-8">
<!-- !!!!!!!!!!Used for testing only!!!!!!!!! -->
<!-- point browser to this file via file:///(your path to)/assets/chrome_windy.html -->
<html>
<head>
    <script src="https://unpkg.com/leaflet@0.7.7/dist/leaflet.js"></script>
    <script src="https://api4.windy.com/assets/libBoot.js"></script>
    <script src="file:///Users/ericfoertsch/Documents/git/SoaringForecast/app/src/main/assets/svgicon.js"></script>


    <style>
    #windy {
      width: 100%;
      height: 400px;
    }

    </style>
</head>
<body>
<div id="windy"></div>
<button onclick="testFunction()">Test</button>
<button onclick="testFunction2()">Test2</button>


<style>
        /* #windy #mobile-ovr-select,   /* the wind/rain/... picker */
       /* #windy #embed-zoom {         /* zoom +/- (use pinch/zoom) */
            display: none !important;
        }
        */

</style>

<script type="text/javascript">

var taskTurnpoints = [{"latitudeDeg": 42.425003,"longitudeDeg": -71.79117,"title": "Sterling"}
        , {"latitudeDeg": 42.43,"longitudeDeg": -72.0,"title": "Random"}
        ,{"latitudeDeg": 42.5,"longitudeDeg": -72.5,"title": "End"}]

var store
var windyMap
var taskLayerGroup
var turnpointIcon
var turnpointPolyLine
var mapMarker = new Array()
var mapPolyLine = new Array()
var taskLayerGroup

function testFunction(){
    //getWindyDiv()
    removeTaskFromMap()
    createMarkersAndPolyLine(taskTurnpoints)
 }

 function testFunction2(){
  // removeTaskFromMap()
  setHeight(800)
 }

 //Sterling
// var lat = 43.1393051
// var lon =  -72.076004

//Mt Washington
 var lat = 44.2705835
 var lon = -71.3207819

 function setWindMap(store, map){
   this.store = store
   windyMap = map
   // could not define icon until WindyAPI initialized
   turnpointIcon = new L.DivIcon.SVGIcon( { "color":"rgb(255,0,0)" ,"fillOpacity": 1})
   turnpointPolyLine = {
                    color: 'red',
                    weight: 2,
                    opacity: 1,
                    zIndex: 1000,
                    className: 'polyTrack'};
  }

  function setModel(model){
       store.set('product',model)
     }

    function setLayer(layer){
       store.set('overlay', layer)
    }

    function setAltitude(altitude){
       store.set('level', altitude)
    }

 function removeTaskFromMap(){
  if (windyMap && taskLayerGroup){
     windyMap.removeLayer(taskLayerGroup)
    }
    if(mapMarker){
      mapMarker.length = 0
    }
    if (mapPolyLine){
      mapPolyLine.length = 0
    }
  }

 function getWindyDiv(){
   var windyDiv = document.getElementById("windy")
   console.log("Height" + windyDiv.offsetHeight)
   windyDiv.style.height = "900px"
   console.log("got windy element")
 }

    // Always true for this debug version
    function androidConnected() {
          return true;
    }

    function getWindyKey() {
      if (androidConnected()) {
        return "y852QwXYurm70lQozoV2rGSLQXoltuQc";
      }
    }

    function getLat() {
      if (androidConnected()) {
        console.log("lat = " + android.getLat());
        return android.getLat();
      }
    }

    function getLong() {
      if (androidConnected()) {
        console.log("long = " + android.getLong());
        return android.getLong();
      }
    }

    function getZoom() {
      if (androidConnected()) {
        return android.getZoom();
      }
    }

    // Does not set map height dynamically. Need to figure out how to to
    function setHeight(height) {
        document.getElementById("windy")
          .clientHeight = height + "px";
          map.invalidateSize();
    }


    // getTaskTurnpointsForMap is app function
    //var taskTurnpoints = getTaskTurnpointsForMap()

    function createMarkersAndPolyLine(taskTurnpoints) {
     if (taskTurnpoints != null) {
       for (i = 0; i < taskTurnpoints.length; i++) {
          var latLong = [taskTurnpoints[i].latitudeDeg, taskTurnpoints[i].longitudeDeg];
           mapPolyLine.push(latLong)
           marker = L.marker(latLong,{icon: turnpointIcon})
           // !!!.toFixed(1) gives (currently) error on end of taskTurnpoints[i].distanceFromStartingPoint on Chrome !!!
           marker.bindPopup(taskTurnpoints[i].title + "\n( " + taskTurnpoints[i].distanceFromStartingPoint +"km)")
           mapMarker.push(marker)
       }
        taskLayerGroup = L.layerGroup(mapMarker).addLayer(L.polyline(mapPolyLine, turnpointPolyLine))
        taskLayerGroup.addTo(windyMap)
        console.log("Done with plotting turnpoints")
      }
    }

    const options = {

                // Required: API key
                 key: 'y852QwXYurm70lQozoV2rGSLQXoltuQc',

                // Put additional console output
                verbose: true,

                // Optional: Initial state of the map
                lat: lat,
                lon:  lon,
                zoom: 7
        }
    // Initialize Windy API
    windyInit(options, windyAPI => {
      // windyAPI is ready, and contain 'map', 'store',
      // 'picker' and other usefull stuff
      // .map is instance of Leaflet map
      //const { map } = windyAPI
      const {
        map,
        utils,
        picker,
        pickerMobile,
        overlays,
        broadcast,
        store
      } = windyAPI


function getHeight(){
  return 700;
  }
document.getElementById("windy").height= getHeight();
map.invalidateSize();

    setWindMap(store, map)

     console.log("windyAPI.store.layer:" + windyAPI.store.get('overlay'))
     console.log("levels:" + windyAPI.store.get('availLevels'))


      console.log("Allowed products: " + windyAPI.store.getAllowed('product'))
      console.log("Allowed overlays: " + windyAPI.store.getAllowed('overlay'))
      console.log("Allowed levels: " + windyAPI.store.getAllowed('level'))
 })

</script>

</body>
</html>